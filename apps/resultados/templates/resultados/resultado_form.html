{% extends "base.html" %}
{% load static %}
{% load template_filters %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <form method="post" id="resultadoForm">
                {% csrf_token %}
                <div class="card shadow-sm">

                    {# ----------------------- CABECERA DINÁMICA ----------------------- #}
                    <div class="card-header text-white d-flex justify-content-between align-items-center"
                         style="background-color: {% if modo_validacion %}#fd7e14{% elif object.estado == 'Validado' %}#198754{% else %}#2A3F54{% endif %};">
                        <h3 class="mb-0"><i class="fas fa-flask me-2"></i>{{ titulo }}</h3>
                        <span class="badge bg-light text-dark">{{ object.get_estado_display }}</span>
                    </div>

                    <div class="card-body p-4">

                        {# ----------------------- TABLA DE PARÁMETROS ----------------------- #}
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <tbody>
                                    {% for param in parametros_list %}
                                        <tr>
                                            <td>
                                                <strong>{{ param.examen.nombre }}</strong>
                                                <small class="d-block text-muted">
                                                    {{ param.rango_referencia }} {{ param.unidad_medida }}
                                                </small>
                                            </td>
                                            <td>
                                                {% if object.estado == 'Validado' %}
                                                    <input type="text" class="form-control" 
                                                           value="{{ detalles_map|get:param.pk }}" disabled>
                                                {% else %}
                                                    <input type="text" 
                                                           name="valor_obtenido_{{ param.pk }}"
                                                           class="form-control"
                                                           value="{{ detalles_map|get:param.pk|default:'' }}">
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <hr>

                        {# ----------------------- OBSERVACIONES ----------------------- #}
                        <div class="mb-3">
                            <label class="fw-bold">Observaciones</label>
                            {{ form.observaciones_generales }}
                        </div>

                        {{ form.estado }}

                        {# ----------------------- BOTÓN VOLVER (FIJO) ----------------------- #}
                        {% if modo_validacion %}
                            {% url 'validacion_lista' as volver_url %}
                        {% else %}
                            {% url 'resultado_lista' as volver_url %}
                        {% endif %}

                        <div class="d-flex justify-content-between mt-4 p-3 bg-light rounded">
                            <a href="{{ volver_url }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </a>

                            {# ----------------------- BOTONES DE ACCIONES ----------------------- #}
                            <div>

                                {# --- MODO TÉCNICO: INGRESO / EDICIÓN PREVIA --- #}
                                {% if modo_ingreso %}
                                    <button type="submit" name="guardar_borrador" 
                                            class="btn btn-info me-2 text-white">
                                        <i class="fas fa-save me-2"></i>Guardar Borrador
                                    </button>

                                    <button type="submit" name="enviar_validacion" 
                                            class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-2"></i>Finalizar y Enviar a Validar
                                    </button>
                                {% endif %}

                                {# --- MODO JEFE/ADMIN: VALIDACIÓN --- #}
                                {% if modo_validacion %}
                                    <button type="submit" name="guardar_borrador" 
                                            class="btn btn-info me-2 text-white"
                                            title="Guardar cambios sin validar">
                                        <i class="fas fa-save me-2"></i>Guardar Cambios
                                    </button>

                                    <button type="submit" name="devolver_correccion" 
                                            class="btn btn-warning me-2">
                                        <i class="fas fa-undo me-2"></i>Devolver a Corrección
                                    </button>

                                    <button type="submit" name="validar_finalizar" 
                                            class="btn btn-success"
                                            onclick="return confirm('¿Confirmar validación final? La orden se cerrará.')">
                                        <i class="fas fa-check-double me-2"></i>VALIDAR Y FINALIZAR
                                    </button>
                                {% endif %}

                                {# --- MODO SOLO LECTURA (ORDEN VALIDADA) --- #}
                                {% if object.estado == 'Validado' %}
                                    <span class="text-success fw-bold">
                                        <i class="fas fa-lock me-2"></i>
                                        Orden Cerrada por {{ object.validado_por }}
                                    </span>
                                {% endif %}

                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
