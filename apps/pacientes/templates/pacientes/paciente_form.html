{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_js %}
<script>
    // Pasar valores de Django (PacienteForm) al JS
    window.regexPatterns = {
        nombre: "{{ form.get_regex_patterns.nombre|escapejs }}",
        apellido: "{{ form.get_regex_patterns.apellido|escapejs }}",
        dui: "{{ form.get_regex_patterns.dui|escapejs }}",
        telefono: "{{ form.get_regex_patterns.telefono|escapejs }}",
        correo: "{{ form.get_regex_patterns.correo|escapejs }}"
    };

    window.errorMessages = {
        nombre: "{{ form.get_error_messages.nombre|escapejs }}",
        apellido: "{{ form.get_error_messages.apellido|escapejs }}",
        dui: "{{ form.get_error_messages.dui|escapejs }}",
        telefono: "{{ form.get_error_messages.telefono|escapejs }}",
        correo: "{{ form.get_error_messages.correo|escapejs }}",
        campo_vacio: "{{ form.get_error_messages.campo_vacio|escapejs }}",
        seleccion_vacia: "{{ form.get_error_messages.seleccion_vacia|escapejs }}"
    };

    window.serverErrors = [
        {% if form.errors %}
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    "{{ error|escapejs }}",
                {% endfor %}
            {% endfor %}
        {% endif %}
    ];
</script>

<script>
    // ==========================================
    // === CÁLCULO AUTOMÁTICO DE EDAD (JS) ===
    // ==========================================
    
    document.addEventListener('DOMContentLoaded', function() {
        const inputFecha = document.getElementById('inputFechaNacimiento');
        const inputEdad = document.getElementById('id_edad_visual'); // Django genera este ID

        if (inputFecha && inputEdad) {
            
            // 1. Calcular si ya hay fecha (al editar)
            if (inputFecha.value) {
                calcularYMostrarEdad(inputFecha.value, inputEdad);
            }

            // 2. Escuchar cambios en la fecha
            inputFecha.addEventListener('change', function() {
                calcularYMostrarEdad(this.value, inputEdad);
            });
            
            // También escuchar mientras escribe (opcional, útil si escriben manualmente)
            inputFecha.addEventListener('keyup', function() {
                if (this.value.length === 10) { // Formato completo YYYY-MM-DD
                    calcularYMostrarEdad(this.value, inputEdad);
                }
            });
        }
    });

    function calcularYMostrarEdad(fechaString, inputDestino) {
        if (!fechaString) {
            inputDestino.value = "";
            return;
        }

        const hoy = new Date();
        const cumpleanos = new Date(fechaString);
        
        // Validar que sea una fecha válida
        if (isNaN(cumpleanos.getTime())) {
            inputDestino.value = "";
            return;
        }

        let edad = hoy.getFullYear() - cumpleanos.getFullYear();
        const mes = hoy.getMonth() - cumpleanos.getMonth();

        // Ajustar si no ha cumplido años todavía este año
        if (mes < 0 || (mes === 0 && hoy.getDate() < cumpleanos.getDate())) {
            edad--;
        }

        // Lógica para bebés (mostrar meses si es menor de 1 año)
        if (edad < 0) {
            inputDestino.value = "Fecha futura inválida";
        } else if (edad === 0) {
            // Calcular meses
            let meses = (hoy.getFullYear() - cumpleanos.getFullYear()) * 12;
            meses -= cumpleanos.getMonth();
            meses += hoy.getMonth();
            if (hoy.getDate() < cumpleanos.getDate()) {
                meses--;
            }
            inputDestino.value = meses + " meses";
        } else {
            inputDestino.value = edad + " años";
        }
    }
</script>

<script src="{% static 'pacientes/js/paciente_validaciones.js' %}"></script>
{% endblock %}


{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="card shadow-sm">
                <div class="card-header text-white" style="background-color: #2A3F54;">
                    <h3 class="text-center mb-0"><i class="fas fa-user-injured me-2"></i>{{ titulo }}</h3>
                </div>
                <div class="card-body p-4">
                    
                    <form method="post" id="pacienteForm" novalidate>
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-8">
                                
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>Datos Personales</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.nombre.id_for_label }}" class="form-label fw-bold">Nombre</label>
                                                {{ form.nombre }}
                                                <div class="valid-feedback">✓ Campo válido</div>
                                                <div class="invalid-feedback"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.apellido.id_for_label }}" class="form-label fw-bold">Apellido</label>
                                                {{ form.apellido }}
                                                <div class="valid-feedback">✓ Campo válido</div>
                                                <div class="invalid-feedback"></div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label fw-bold">Fecha de Nacimiento</label>
                                                {{ form.fecha_nacimiento }}
                                                <div class="valid-feedback">✓ Campo válido</div>
                                                <div class="invalid-feedback"></div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label fw-bold">Edad</label>
                                                <input type="text" class="form-control bg-light" readonly="readonly" 
                                                    id="inputEdadDinamica" placeholder="Se calculará automáticamente"
                                                    value="{% if form.instance.fecha_nacimiento %}{{ form.instance.edad }} años{% endif %}" >
                                                {{ form.edad_al_registro }} 
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.sexo.id_for_label }}" class="form-label fw-bold">Sexo</label>
                                                {{ form.sexo }}
                                                <div class="valid-feedback">✓ Campo válido</div>
                                                <div class="invalid-feedback"></div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.dui.id_for_label }}" class="form-label fw-bold">DUI</label>
                                                {{ form.dui }}
                                                <div class="valid-feedback">✓ Campo válido</div>
                                                <div class="invalid-feedback"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.telefono.id_for_label }}" class="form-label fw-bold">Teléfono</label>
                                                {{ form.telefono }}
                                                <div class="valid-feedback">✓ Campo válido</div>
                                                <div class="invalid-feedback"></div>
                                            </div>

                                            <div class="col-12 mb-3">
                                                <label for="{{ form.correo.id_for_label }}" class="form-label fw-bold">Correo Electrónico</label>
                                                {{ form.correo }}
                                                <div class="valid-feedback">✓ Campo válido</div>
                                                <div class="invalid-feedback"></div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4">
                                    <a href="{% url 'paciente_list' %}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Volver al Listado</a>
                                    <button type"submit" class="btn btn-success" id="submitBtn">
                                        <i class="fas fa-save me-2"></i>Guardar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card sticky-top" style="top: 20px;">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Consejos Útiles</h5>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="fw-bold"><i class="fas fa-hospital-user text-warning me-2"></i>Datos Demográficos</h6>
                                         <ul class="ps-3 mb-3">
                                             <li>La "Fecha de Nacimiento" es crucial para calcular la edad correcta, vital en los resultados de laboratorio.</li>
                                             <li>El campo "Sexo" es fundamental para aplicar los rangos de referencia adecuados en los exámenes.</li>
                                         </ul>
                                        <h6 class="fw-bold"><i class="fas fa-address-book text-info me-2"></i>Contacto y Citas</h6>
                                        <ul class="ps-3">
                                             <li>El "Teléfono" y el "Correo" permiten la notificación rápida de resultados o la gestión de citas.</li>
                                             <li>El "DUI" (o Documento de Identidad) asegura la unicidad del registro del paciente.</li>
                                         </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
